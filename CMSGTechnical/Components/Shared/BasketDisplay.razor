@using CMSGTechnical.Code
@using CMSGTechnical.Domain.Models
@using CMSGTechnical.Mediator.Basket
@using CMSGTechnical.Mediator.Dtos
@using MediatR

<div class="basket">
    @foreach (var group in BasketService.Basket.MenuItems.GroupBy(i => new {i.Name }  ))
    {
        var item = group.First();

        <div class="basket-item">
            <div class="basket-item-name">
                @item.Name
            </div>

            <div class="basket-item-price">
                £@item.Price
            </div>

            <div class="basket-item-quantity">
                x @group.Count()
            </div>



            <div class="basket-item-buttons">
             
                <button class="btn btn-primary btn-round" @onclick="() => AddItem(item)">+</button>
                <button class="btn btn-primary btn-round" @onclick="() => Remove(item)">-</button>
            </div>

        </div>
    }

    
    <div class="mt-3 total-calculation">
        <div class="subtotal">
            <strong>Subtotal: £@Basket.MenuItems.Sum(i => i.Price).ToString("F2")</strong>
        </div>
        <div class="delivery-fee">
            <strong>Delivery Fee: £2.00</strong>
        </div>
        @if(Basket.MenuItems.Count > 0)
        {
            
        <div class="total">
            <strong>Total: £@CalculateTotal().ToString("F2")</strong>
        </div>
        }
    </div>
</div>


@code {



    [Inject] private IMediator Mediator { get; set; } = default!;

    private BasketDto Basket { get; set; } = new();
    [CascadingParameter]
    private BasketService BasketService { get; set; }


    protected override void OnInitialized()
    {
        Basket = BasketService.Basket;
        BasketService.OnChange += (sender, args) => StateHasChanged();
    }   


    async public void AddItem(MenuItemDto item)
    {

        await BasketService.Add(item);
        StateHasChanged();
    }

    async public void Remove(MenuItemDto item)
    {

        await BasketService.Remove(item);
        StateHasChanged();
    }

  

    private decimal CalculateTotal()
    {
        const decimal deliveryFee = 2.00m;
        var subtotal = Basket.MenuItems.Sum(i => i.Price);
        return subtotal + deliveryFee;
    }


}
